<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Assistente de Conex√£o RTSP</title>
  <style>
    body { font-family: Arial; padding: 40px; text-align: center; }
    input { width: 60%; padding: 10px; font-size: 16px; margin: 6px 0; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px 5px; cursor: pointer; }
    table { border-collapse: collapse; margin: 30px auto; width: 90%; max-width: 900px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    caption { font-weight: bold; margin-bottom: 10px; font-size: 18px; }
    tr:hover { background-color: #f9f9f9; cursor: pointer; }
    code { background-color: #f7f7f7; padding: 2px 4px; border-radius: 4px; }
    .step { display: none; }
    .active { display: block; }
    #stream { max-width: 100%; border: 1px solid #ccc; margin-top: 20px; }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 10px;
      vertical-align: middle;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <h2>üìπ Assistente de Conex√£o de C√¢meras RTSP</h2>

  <!-- Etapa 1 -->
  <div id="step1" class="step active">
    <h3>1Ô∏è‚É£ Informe o usu√°rio e senha padr√£o das c√¢meras</h3>
    <input id="user" placeholder="Usu√°rio (ex: admin)" value="admin"><br>
    <input id="pass" placeholder="Senha (ex: 12345)" value="eletriseg34263426" type="password"><br>
    <button id="next1">Avan√ßar</button>
  </div>

  <!-- Etapa 2 -->
  <div id="step2" class="step">
    <h3>2Ô∏è‚É£ Informe o IP e a porta RTSP da c√¢mera</h3>
    <input id="ip" placeholder="IP (ex: 192.168.15.10)" value="192.168.15.10"><br>
    <input id="port" placeholder="Porta RTSP (ex: 546)" value="546"><br>
    <button id="back2">Voltar</button>
    <button id="next2">Avan√ßar</button>
  </div>

  <!-- Etapa 3 -->
  <div id="step3" class="step">
    <h3>3Ô∏è‚É£ Selecione o modelo de c√¢mera ou copie a URL</h3>
    <input id="rtspUrl" placeholder="rtsp://usuario:senha@ip:porta/path"><br>
    <button id="back3">Voltar</button>
    <button id="next3">Testar Conex√£o</button>
    <p id="status3a"></p>

    <table id="cameraTable">
      <caption>üßæ Modelos de c√¢meras (clique para preencher)</caption>
      <thead>
        <tr>
          <th>Fabricante / Firmware</th>
          <th>Exemplo de URL RTSP</th>
        </tr>
      </thead>
      <tbody id="cameraTableBody"></tbody>
    </table>
  </div>

  <!-- Etapa 4 -->
  <div id="step4" class="step">
    <h3>4Ô∏è‚É£ Visualiza√ß√£o da C√¢mera</h3>
    <button id="back4">Voltar</button>
    <div id="status4">üîå Tentando conectar...</div>
    <div id="spinnerContainer"></div>
    <img id="stream" alt="stream">
  </div>

  <script>
    const [step1, step2, step3, step4] = [
      document.getElementById('step1'),
      document.getElementById('step2'),
      document.getElementById('step3'),
      document.getElementById('step4')
    ];

    const userInput = document.getElementById('user');
    const passInput = document.getElementById('pass');
    const ipInput = document.getElementById('ip');
    const portInput = document.getElementById('port');
    const rtspInput = document.getElementById('rtspUrl');
    const tableBody = document.getElementById('cameraTableBody');
    const status4 = document.getElementById('status4');
    const spinnerContainer = document.getElementById('spinnerContainer');
    const streamImg = document.getElementById('stream');
    const next3Btn = document.getElementById('next3');

    const templates = [
      { name: 'Dahua / Intelbras / Tecvoz / Greatek', path: '/cam/realmonitor?channel=1&subtype=0' },
      { name: 'Hikvision / Multilaser', path: '/Streaming/Channels/101' },
      { name: 'Provision / Luxvision', path: '/Streaming/Channels/1' },
      { name: 'TP-Link / Tapo', path: '/stream1' },
      { name: 'Foscam / Wanscam / gen√©ricas', path: '/videoMain' },
      { name: 'Amcrest / Reolink / Annke', path: '/cam/realmonitor?channel=1&subtype=0' },
      { name: 'ONVIF (padr√£o universal)', path: '/Streaming/Channels/101' }
    ];

    function showStep(step) {
      [step1, step2, step3, step4].forEach(s => s.classList.remove('active'));
      step.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('next1').addEventListener('click', () => {
      const user = userInput.value.trim();
      const pass = passInput.value.trim();
      if (!user || !pass) return alert('Preencha usu√°rio e senha.');
      showStep(step2);
    });

    document.getElementById('back2').addEventListener('click', () => {
        streamImg?.src = url;
        showStep(step1)
    });
    document.getElementById('back3').addEventListener('click', () => {
        streamImg?.src = url;
        showStep(step2)
    
    });
    document.getElementById('back4').addEventListener('click', () => {
      streamImg?.src = url;
      next3Btn.disabled = false;
      next3Btn.textContent = 'Testar Conex√£o';
      spinnerContainer.innerHTML = '';
      showStep(step3);
    });

    document.getElementById('next2').addEventListener('click', () => {
      const ip = ipInput.value.trim();
      const port = portInput.value.trim();
      if (!ip || !port) return alert('Informe IP e porta RTSP.');
      preencherTabela(userInput.value, passInput.value, ip, port);
      showStep(step3);
    });

    function preencherTabela(user, pass, ip, port) {
      tableBody.innerHTML = '';
      templates.forEach(t => {
        const url = `rtsp://${user}:${pass}@${ip}:${port}${t.path}&rtsp_transport=tcp`;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><b>${t.name}</b></td><td><code>${url}</code></td>`;
        tr.addEventListener('click', () => {
          rtspInput.value = url;
          document.getElementById('status3a').textContent = 'üîß Exemplo carregado. Edite se necess√°rio antes de testar.';
        });
        tableBody.appendChild(tr);
      });
    }

    document.getElementById('next3').addEventListener('click', async () => {
      const rtspUrl = rtspInput.value.trim();
      if (!rtspUrl) return alert('Selecione ou informe uma URL RTSP.');

      next3Btn.disabled = true;
      next3Btn.textContent = 'Conectando...';
      status4.textContent = 'üîå Tentando conectar...';
      spinnerContainer.innerHTML = '<div class="spinner"></div>';
      showStep(step4);

      try {
        const { url } = await window.cameraApi.startStream({ rtspUrl, id: 'cam1' });
        streamImg.src = url;
        spinnerContainer.innerHTML = '';
      } catch (err) {
        spinnerContainer.innerHTML = '';
        status4.textContent = `‚ùå Erro: ${err.message}`;
        showStep(step3);
      } finally {
        next3Btn.disabled = false;
        next3Btn.textContent = 'Testar Conex√£o';
        status4.textContent = ''
      }
    });
  </script>
</body>
</html>
