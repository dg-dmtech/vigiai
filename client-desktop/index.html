<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Assistente de Conex√£o RTSP</title>
  <style>
    body { font-family: Arial; padding: 40px; text-align: center; }
    input { width: 60%; padding: 10px; font-size: 16px; margin: 6px 0; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px 5px; cursor: pointer; }
    table { border-collapse: collapse; margin: 30px auto; width: 90%; max-width: 900px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    caption { font-weight: bold; margin-bottom: 10px; font-size: 18px; }
    tr:hover { background-color: #f9f9f9; cursor: pointer; }
    code { background-color: #f7f7f7; padding: 2px 4px; border-radius: 4px; }
    .step { display: none; }
    .active { display: block; }
    #stream { max-width: 100%; border: 1px solid #ccc; margin-top: 20px; }
    /* Spinner simples */
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <h2>üìπ Assistente de Conex√£o de C√¢meras RTSP</h2>

  <!-- Etapa 1 -->
  <div id="step1" class="step active">
    <h3>1Ô∏è‚É£ Informe o usu√°rio e senha padr√£o das c√¢meras</h3>
    <input id="user" placeholder="Usu√°rio (ex: admin)" value="admin"><br>
    <input id="pass" placeholder="Senha (ex: 12345)" type="password"><br>
    <button id="next1">Avan√ßar</button>
  </div>

  <!-- Etapa 2 -->
  <div id="step2" class="step">
    <h3>2Ô∏è‚É£ Selecione o modelo de c√¢mera ou copie a URL</h3>
    <input id="rtspUrl" placeholder="rtsp://usuario:senha@ip:porta/path"><br>
    <button id="back2">Voltar</button>
    <button id="next2">Testar Conex√£o</button>
    <p id="status2"></p>

    <table id="cameraTable">
      <caption>üßæ Modelos de c√¢meras (clique para preencher)</caption>
      <thead>
        <tr>
          <th>Fabricante / Firmware</th>
          <th>Exemplo de URL RTSP</th>
        </tr>
      </thead>
      <tbody id="cameraTableBody"></tbody>
    </table>
  </div>

  <!-- Etapa 3 -->
  <div id="step3" class="step">
    <h3>3Ô∏è‚É£ Visualiza√ß√£o da C√¢mera</h3>
    <button id="back3">Voltar</button>
    <div id="status3">üîå Tentando conectar...</div>
    <div id="spinnerContainer"></div>
    <img id="stream" alt="stream">
  </div>

  <script>
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const userInput = document.getElementById('user');
    const passInput = document.getElementById('pass');
    const rtspInput = document.getElementById('rtspUrl');
    const status2 = document.getElementById('status2');
    const status3 = document.getElementById('status3');
    const streamImg = document.getElementById('stream');
    const spinnerContainer = document.getElementById('spinnerContainer');
    const tableBody = document.getElementById('cameraTableBody');
    const next2Btn = document.getElementById('next2');

    const templates = [
      { name: 'Dahua / Intelbras / Tecvoz / Greatek', path: '/cam/realmonitor?channel=1&subtype=0' },
      { name: 'Hikvision / Multilaser', path: '/Streaming/Channels/101' },
      { name: 'Provision / Luxvision', path: '/Streaming/Channels/1' },
      { name: 'TP-Link / Tapo', path: '/stream1' },
      { name: 'Foscam / Wanscam / gen√©ricas', path: '/videoMain' },
      { name: 'Amcrest / Reolink / Annke', path: '/cam/realmonitor?channel=1&subtype=0' },
      { name: 'ONVIF (padr√£o universal)', path: '/Streaming/Channels/101' }
    ];

    function showStep(step) {
      [step1, step2, step3].forEach(s => s.classList.remove('active'));
      step.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('next1').addEventListener('click', () => {
      const user = userInput.value.trim();
      const pass = passInput.value.trim();
      if (!user || !pass) return alert('Preencha usu√°rio e senha.');
      preencherTabela(user, pass);
      showStep(step2);
    });

    document.getElementById('back2').addEventListener('click', () => showStep(step1));
    document.getElementById('back3').addEventListener('click', () => {
      next2Btn.disabled = false;
      next2Btn.textContent = 'Testar Conex√£o';
      spinnerContainer.innerHTML = '';
      showStep(step2);
    });

    function preencherTabela(user, pass) {
      tableBody.innerHTML = '';
      templates.forEach(t => {
        const url = `rtsp://${user}:${pass}@192.168.15.10:546${t.path}&rtsp_transport=tcp`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${t.name}</b></td>
          <td><code>${url}</code></td>
        `;
        tr.addEventListener('click', () => {
          rtspInput.value = url;
          status2.textContent = 'üîß Exemplo carregado. Edite o IP se necess√°rio antes de testar.';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        tableBody.appendChild(tr);
      });
    }

    document.getElementById('next2').addEventListener('click', async () => {
      const rtspUrl = rtspInput.value.trim();
      if (!rtspUrl) return alert('Selecione ou informe uma URL RTSP.');

      next2Btn.disabled = true;
      next2Btn.textContent = 'Conectando...';
      status3.textContent = 'üîå Tentando conectar...';
      spinnerContainer.innerHTML = '<div class="spinner"></div>';
      showStep(step3);

      try {
        next2Btn.disabled = true;
        const { url } = await window.cameraApi.startStream({ rtspUrl, id: 'cam1' });
        streamImg.src = url;
        spinnerContainer.innerHTML = '';
        status3.textContent = `‚úÖ Conectado √† c√¢mera:\n${rtspUrl}`;
      } catch (err) {
        spinnerContainer.innerHTML = '';
        status3.textContent = `‚ùå Erro: ${err.message}`;
        showStep(step2);
      } finally {
        next2Btn.disabled = false;
        next2Btn.textContent = 'Testar Conex√£o';
      }
    });
  </script>
</body>
</html>
